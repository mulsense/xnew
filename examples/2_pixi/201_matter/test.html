<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="../../dist/xnew.js"></script>
  <script src="../../thirdparty/matter/matter.js"></script>
</head>

<body style="margin: 0; height: 100vh;">
  <div id="main" style="width: 100%; height: 100%;"></div>
  <script>
    xnew('#main', (self) => {
      const screen = xnew(xnew.basics.Screen, { width: 800, height: 450 });

      const main = xnew(MatterMain, { canvas: screen.element });

      const button = xnew('<button style="position: absolute; top: 0;">', 'reset');
      button.on('click', () => {
        main.reboot();
      });
    });

    function MatterMain(self, { canvas }) {
      const engine = Matter.Engine.create();
      const render = Matter.Render.create({
        canvas, engine,
        options: {
          width: canvas.width,
          height: canvas.height,
          hasBounds: true,
          wireframes: true,
        }
      });
      Matter.Composite.add(engine.world, Matter.MouseConstraint.create(engine, { element: canvas }));

      xnew.extend(MatterObject, engine.world);

      const contents = xnew(MatterContents);

      self.on('update', () => {
        Matter.Engine.update(engine);
        Matter.Render.world(render);
      });
    }

    function MatterObject(self, object) {
      const parent = xnew.context('MatterObject');
      xnew.context('MatterObject', object);

      parent && Matter.Composite.add(parent, object);
      self.on('finalize', () => {
        parent && Matter.Composite.remove(parent, object);
      });
    }

    function MatterContents(self) {
        xnew(LShape, { x: 400, y: 50, size: 50, color: 0xCC00CC });
    //   xnew(Rectangle, [400, 200, 80, 80]);
    //   xnew(Polygon, [450, 50, 6, 40]);
    //   xnew(Circle, [350, 50, 40]);
       xnew(Rectangle, [400, 400, 800, 20, { isStatic: true }]);
    }
    function LShape(self, { x, y, color, size, options = {} }) {
        const a = size;
        const b = size / 111;

        const bar1 = Matter.Bodies.rectangle(0, 0, a * 2, b * 2);
        const bar2 = Matter.Bodies.rectangle(-3 * a, 0, b * 2, a * 2);
        const compound = Matter.Body.create({ parts: [bar1, bar2], centre: { x: 0, y: 0 } });
        xnew.extend(MatterObject, compound);
        Matter.Body.setCentre(compound, { x: 0, y: 0 }, false);
        Matter.Body.setPosition(compound, { x, y });

        // const graphics = new PIXI.Graphics();
        // graphics.rect(-a, -b, a * 2, b * 2).fill(0x000000);
        // graphics.rect(-b, -a, b * 2, a * 2).fill(0x000000);
        // graphics.rect(-a, -b - a + b, a * 2, b * 2).fill(color);
        // graphics.rect(-b - a + b, -a, b * 2, a * 2).fill(color);
        // object.addChild(graphics);
        // object.position.set(x, y);

        // self.on('update', () => {
        //     object.rotation = compound.angle;
        //     object.position.set(compound.position.x, compound.position.y);
        // });
    }

    function Rectangle(self, args) {
      const object = Matter.Bodies.rectangle(...args)
      xnew.extend(MatterObject, object);
    }

    function Circle(self, args) {
      const object = Matter.Bodies.circle(...args)
      xnew.extend(MatterObject, object);
    }

    function Polygon(self, args) {
      const object = Matter.Bodies.polygon(...args)
      xnew.extend(MatterObject, object);
    }
  </script>
</body>
</html>